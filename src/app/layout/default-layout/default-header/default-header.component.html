<!-- src/app/layout/default-layout/default-header/default-header.component.html -->

<ng-container>
  <c-container [fluid]="true" class="border-bottom px-4 d-flex align-items-center">
    <!-- Bouton menu (sidebar) -->
    <button
      [cSidebarToggle]="sidebarId()"
      cHeaderToggler
      class="btn btn-link px-0 me-3 d-inline-flex align-items-center"
      toggle="visible"
      style="margin-inline-start: -14px;"
      aria-label="Toggle sidebar navigation"
    >
      <svg cIcon name="cilMenu" size="lg"></svg>
    </button>

    <!-- Menus principaux avec contr√¥le des r√¥les -->
    <c-header-nav class="d-none d-md-flex align-items-center">
      <c-nav-item>
        <a cNavLink routerLink="/dashboard" routerLinkActive="active">Dashboard</a>
      </c-nav-item>

      <!-- Visible uniquement pour les admins -->
      <c-nav-item *ngIf="isAdmin">
        <a cNavLink routerLink="/users" routerLinkActive="active">Users</a>
      </c-nav-item>

      <!-- Visible pour admin OU steward -->
      <c-nav-item *ngIf="isAdmin || isSteward">
        <a cNavLink routerLink="/settings" routerLinkActive="active">Settings</a>
      </c-nav-item>
    </c-header-nav>

    <!-- Espace flexible au milieu -->
    <div class="flex-grow-1"></div>

    <!-- üî• Global auto-refresh toggle -->
    <c-header-nav class="d-none d-md-flex align-items-center me-3">
      <label class="form-check form-switch mb-0 d-flex align-items-center gap-2 small">
        <input
          type="checkbox"
          class="form-check-input"
          [checked]="rt.autoRefresh()"
          (change)="rt.autoRefresh.set($any($event.target).checked)"
        />
        <span class="text-muted">Auto-refresh temps r√©el</span>
      </label>
    </c-header-nav>

    <!-- Ic√¥nes de droite (notifications + autres, masqu√©es pour viewer si souhait√©) -->
    <c-header-nav class="d-none d-md-flex align-items-center me-3" *ngIf="!isViewer">
      <!-- üîî Cloche notifications temps r√©el -->
      <div class="nav-item dropdown me-2">
        <button
          class="btn btn-link nav-link p-0 d-inline-flex align-items-center justify-content-center position-relative"
          type="button"
          (click)="toggleNotifDropdown()"
          aria-label="Open notifications"
        >
          <svg cIcon name="cilBell" size="lg"></svg>

          <!-- Badge nombre de non lus -->
          <span
            *ngIf="unreadCount > 0"
            class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-flex align-items-center justify-content-center"
            style="min-width: 1.1rem; height: 1.1rem; font-size: 0.65rem;"
          >
            {{ unreadCount > 9 ? '9+' : unreadCount }}
          </span>
        </button>

        <!-- Dropdown notifications -->
        <div
          class="dropdown-menu dropdown-menu-end p-0 mt-2 show border-0 shadow-lg rounded-3"
          *ngIf="showNotifDropdown"
          style="min-width: 340px; max-width: 360px;"
        >
          <!-- Header du dropdown -->
          <div class="px-3 py-2 border-bottom d-flex justify-content-between align-items-center">
            <span class="fw-semibold small text-uppercase text-muted">Notifications</span>
            <span
              *ngIf="notifications.length"
              class="badge bg-primary rounded-pill"
            >
              {{ notifications.length }}
            </span>
          </div>

          <!-- Liste des notifications -->
          <div
            class="list-group list-group-flush"
            style="max-height: 320px; overflow-y: auto;"
            *ngIf="notifications.length; else noNotif"
          >
            <button
              type="button"
              class="list-group-item list-group-item-action py-2"
              *ngFor="let n of notifications; let i = index"
              (click)="openNotification(n, i)"
            >
              <div class="d-flex w-100 justify-content-between align-items-start">
                <div class="me-2 flex-grow-1">
                  <h6 class="mb-1 fw-semibold small">
                    {{ n.title }}
                  </h6>

                  <!-- üëâ preview tr√®s court (une phrase), tronqu√© -->
                  <p
                    class="mb-1 small text-body-secondary"
                    style="
                      white-space: nowrap;
                      overflow: hidden;
                      text-overflow: ellipsis;
                      max-width: 230px;
                    "
                  >
                    {{ (n.message || '') | slice:0:90 }}
                    <ng-container *ngIf="(n.message || '').length > 90">‚Ä¶</ng-container>
                  </p>

                  <small [ngClass]="levelClass(n.level)">
                    {{ n.type }}
                  </small>
                </div>

                <small *ngIf="n.createdAt" class="text-nowrap text-muted ms-2">
                  {{ n.createdAt | date: 'shortTime' }}
                </small>
              </div>
            </button>
          </div>

          <!-- Si aucune notification -->
          <ng-template #noNotif>
            <div class="p-3 text-center text-muted small">
              Aucune notification pour le moment.
            </div>
          </ng-template>

          <!-- Footer du dropdown -->
          <div
            *ngIf="notifications.length"
            class="px-3 py-2 border-top text-center small"
          >
            <a routerLink="/notifications" class="text-decoration-none">
              Voir toutes les notifications
            </a>
          </div>
        </div>
      </div>

      <!-- Autres ic√¥nes (placeholder pour plus tard) -->
      <a
        cNavLink
        class="nav-link d-inline-flex align-items-center justify-content-center px-2"
      >
        <svg cIcon name="cilList" size="lg"></svg>
      </a>
      <a
        cNavLink
        class="nav-link d-inline-flex align-items-center justify-content-center px-2"
      >
        <svg cIcon name="cilEnvelopeOpen" size="lg"></svg>
      </a>
    </c-header-nav>

    <!-- S√©parateur + switch th√®me -->
    <c-header-nav class="ms-auto ms-md-0 d-flex align-items-center">
      <div class="nav-item py-1 d-none d-md-block">
        <div class="vr h-100 mx-2 text-body text-opacity-75"></div>
      </div>
      <ng-container *ngTemplateOutlet="themeDropdown"></ng-container>
      <div class="nav-item py-1 d-none d-md-block">
        <div class="vr h-100 mx-2 text-body text-opacity-75"></div>
      </div>
    </c-header-nav>

    <!-- Message de bienvenue -->
    <c-header-nav class="ms-2 me-2 d-none d-md-flex align-items-center">
      <span class="navbar-text fw-semibold" *ngIf="(user$ | async) as u">
        Bienvenue {{ u.name }}
      </span>
    </c-header-nav>

    <!-- Dropdown utilisateur -->
    <c-header-nav class="mx-0 d-flex align-items-center">
      <ng-container *ngTemplateOutlet="userDropdown"></ng-container>
    </c-header-nav>
  </c-container>

  <c-container [fluid]="true" class="px-4">
    <c-breadcrumb-router />
  </c-container>
</ng-container>

<!-- Dropdown utilisateur -->
<ng-template #userDropdown>
  <!-- inchang√© -->
  <c-dropdown [popperOptions]="{ placement: 'bottom-start' }" variant="nav-item">
    <button
      [caret]="false"
      cDropdownToggle
      class="py-0 pe-0 d-inline-flex align-items-center"
      aria-label="Open user menu"
    >
      <c-avatar
        shape="rounded-1"
        size="md"
        src="./assets/images/avatars/8.jpg"
        status="success"
        textColor="primary"
        alt="User avatar"
      />
    </button>

    <ul cDropdownMenu class="pt-0 w-auto">
      <li>
        <h6
          cDropdownHeader
          class="bg-body-secondary text-body-secondary fw-semibold py-2 rounded-top"
        >
          Account
        </h6>
      </li>

      <li *ngIf="(user$ | async) as u; else loginLink">
        <a cDropdownItem class="disabled">
          <svg cIcon class="me-2" name="cilUser"></svg>
          {{ u.name }} ({{ u.role }})
        </a>
      </li>
      <li *ngIf="(user$ | async)">
        <a cDropdownItem (click)="logout()">
          <svg cIcon class="me-2" name="cilAccountLogout"></svg>
          Logout
        </a>
      </li>

      <ng-template #loginLink>
        <li>
          <a cDropdownItem routerLink="/login">
            <svg cIcon class="me-2" name="cilAccountLogin"></svg>
            Login
          </a>
        </li>
      </ng-template>

      <!-- les items mock que tu avais d√©j√† -->
      <li>
        <a cDropdownItem routerLink="">
          <svg cIcon class="me-2" name="cilBell"></svg>
          Updates
          <c-badge class="ms-2 float-end" color="info">42</c-badge>
        </a>
      </li>
      <li>
        <a cDropdownItem routerLink="/apps/email/inbox">
          <svg cIcon class="me-2" name="cilEnvelopeOpen"></svg>
          Messages
          <c-badge class="ms-2 float-end" color="success">42</c-badge>
        </a>
      </li>
      <li>
        <a cDropdownItem routerLink="">
          <svg cIcon class="me-2" name="cilTask"></svg>
          Tasks
          <c-badge class="ms-2 float-end" color="danger">42</c-badge>
        </a>
      </li>
      <li>
        <a cDropdownItem routerLink="">
          <svg cIcon class="me-2" name="cilCommentSquare"></svg>
          Comments
          <c-badge class="ms-auto" color="warning">42</c-badge>
        </a>
      </li>

      <li>
        <h6
          cDropdownHeader
          class="bg-body-secondary text-body-secondary fw-semibold py-2"
        >
          Settings
        </h6>
      </li>
      <li>
        <a cDropdownItem routerLink="">
          <svg cIcon class="me-2" name="cilUser"></svg>
          Profile
        </a>
      </li>
      <li>
        <a cDropdownItem routerLink="">
          <svg cIcon class="me-2" name="cilSettings"></svg>
          Settings
        </a>
      </li>
      <li>
        <a cDropdownItem routerLink="">
          <svg cIcon class="me-2" name="cilCreditCard"></svg>
          Payments
          <c-badge class="ms-2 float-end" color="secondary">42</c-badge>
        </a>
      </li>
      <li>
        <a cDropdownItem routerLink="">
          <svg cIcon class="me-2" name="cilFile"></svg>
          Projects
          <c-badge class="ms-2 float-end" color="primary">42</c-badge>
        </a>
      </li>
      <li><hr cDropdownDivider /></li>
      <li>
        <a cDropdownItem routerLink="">
          <svg cIcon class="me-2" name="cilLockLocked"></svg>
          Lock Account
        </a>
      </li>
    </ul>
  </c-dropdown>
</ng-template>

<!-- Choix du th√®me -->
<ng-template #themeDropdown>
  <c-dropdown alignment="end" variant="nav-item">
    <button
      [caret]="false"
      cDropdownToggle
      aria-label="Open theme picker"
      class="d-inline-flex align-items-center"
    >
      <svg cIcon [name]="icons()" size="lg"></svg>
    </button>
    <div cDropdownMenu>
      @for (mode of colorModes; track mode.name) {
        <button
          (click)="colorMode.set(mode.name)"
          [active]="colorMode() === mode.name"
          cDropdownItem
          class="d-flex align-items-center"
        >
          <svg cIcon class="me-2" [name]="mode.icon" size="lg"></svg>
          {{ mode.text }}
        </button>
      }
    </div>
  </c-dropdown>
</ng-template>
